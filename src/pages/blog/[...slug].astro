---
import { type CollectionEntry, getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { SITE_URL, SITE_AUTHOR } from '../../consts/site';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts.map((post) => ({
		params: { slug: post.slug },
		props: post,
	}));
}

type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { Content } = await post.render();

function calculateReadingTime(content: string): number {
	const wordsPerMinute = 200;
	const words = content.split(/\s+/).length;
	return Math.ceil(words / wordsPerMinute);
}

const readingTime = calculateReadingTime(post.body);

// Create breadcrumbs
const breadcrumbs = [
	{ name: 'Home', url: SITE_URL },
	{ name: 'Blog', url: `${SITE_URL}/blog` },
	{ name: post.data.title, url: `${SITE_URL}/blog/${post.slug}/` }
];
---

<Layout 
	title={`${post.data.title} | Blog`} 
	description={post.data.description}
	type="article"
	publishedTime={post.data.pubDate.toISOString()}
	modifiedTime={post.data.updatedDate?.toISOString()}
	tags={post.data.tags || []}
	image={post.data.heroImage || '/favicon.svg'}
>
	<script type="application/ld+json" set:html={JSON.stringify({
		"@context": "https://schema.org",
		"@type": "BreadcrumbList",
		"itemListElement": breadcrumbs.map((crumb, index) => ({
			"@type": "ListItem",
			"position": index + 1,
			"name": crumb.name,
			"item": crumb.url
		}))
	})} />
	
	<article class="space-y-10 pt-0" itemscope itemtype="https://schema.org/BlogPosting">
		<header class="space-y-6 pb-8 border-b border-zinc-800">
			<div class="flex items-center gap-2 text-sm text-zinc-400 flex-wrap">
				<time datetime={post.data.pubDate.toISOString()} itemprop="datePublished" content={post.data.pubDate.toISOString()}>
					{post.data.pubDate.toLocaleDateString('en-us', {
						year: 'numeric',
						month: 'short',
						day: 'numeric',
					})}
				</time>
				<span aria-hidden="true" class="text-zinc-600">•</span>
				<span>{readingTime} min read</span>
				{post.data.tags && post.data.tags.length > 0 && (
					<>
						<span aria-hidden="true" class="text-zinc-600">•</span>
						<div class="flex gap-2 flex-wrap">
							{post.data.tags.map(tag => (
								<a href={`/blog?tag=${tag}`} class="text-zinc-400 hover:text-zinc-50 transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-zinc-400 rounded px-1">#{tag}</a>
							))}
						</div>
					</>
				)}
			</div>
			<h1 class="text-4xl font-bold tracking-tight sm:text-5xl leading-tight" itemprop="headline">
				{post.data.title}
			</h1>
			{post.data.heroImage && (
				<div class="aspect-video overflow-hidden rounded-xl bg-zinc-800 mt-6">
					<img
						src={post.data.heroImage}
						alt={`${post.data.title} - Featured image`}
						class="h-full w-full object-cover"
						loading="eager"
						decoding="async"
						fetchpriority="high"
						width="800"
						height="450"
						sizes="(max-width: 768px) 100vw, 800px"
						itemprop="image"
					/>
				</div>
			)}
		</header>
		
		<div class="markdown" itemprop="articleBody">
			<Content />
		</div>
		
		<footer class="pt-10 border-t mt-10 border-zinc-800">
			<a href="/blog" class="text-sm font-medium text-zinc-500 hover:text-zinc-50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-zinc-400 focus-visible:ring-offset-2 focus-visible:ring-offset-zinc-950 rounded inline-flex items-center gap-1.5">
				<span aria-hidden="true">&larr;</span> Back to blog
			</a>
		</footer>
	</article>
</Layout>
